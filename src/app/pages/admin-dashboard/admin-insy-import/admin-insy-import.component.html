<div class="admin-insy-import-container">
  <!-- Header mit Statistiken -->
  <div class="mb-6">
    <div class="flex justify-between items-center mb-4">
      <div>
        <h1 class="text-3xl font-bold text-gray-800">InSy Import-Verwaltung</h1>
        <p class="text-gray-600 mt-2">Verwaltung von Import-Anfragen aus dem InSy-System</p>
      </div>
      <p-button
        label="Mock-Daten laden"
        icon="pi pi-refresh"
        [loading]="isLoading()"
        (onClick)="refreshImports()"
        severity="secondary"
      />
    </div>

    <!-- Statistik-Karten -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <p-card class="shadow-sm">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-600 mb-1">Ausstehend</p>
            <p class="text-2xl font-bold text-orange-500">{{ statistics().totalPending }}</p>
          </div>
          <i class="pi pi-clock text-4xl text-orange-300"></i>
        </div>
      </p-card>

      <p-card class="shadow-sm">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-600 mb-1">Importiert</p>
            <p class="text-2xl font-bold text-green-500">{{ statistics().totalImported }}</p>
          </div>
          <i class="pi pi-check-circle text-4xl text-green-300"></i>
        </div>
      </p-card>

      <p-card class="shadow-sm">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-600 mb-1">Abgelehnt</p>
            <p class="text-2xl font-bold text-red-500">{{ statistics().totalRejected }}</p>
          </div>
          <i class="pi pi-times-circle text-4xl text-red-300"></i>
        </div>
      </p-card>

      <p-card class="shadow-sm">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-600 mb-1">Neu heute</p>
            <p class="text-2xl font-bold text-blue-500">{{ newRequests().length }}</p>
          </div>
          <i class="pi pi-plus-circle text-4xl text-blue-300"></i>
        </div>
      </p-card>
    </div>
  </div>

  <!-- Filter und Suche -->
  <p-card class="shadow-sm mb-6">
    <div class="flex flex-wrap gap-4 items-end">
      <!-- Suche -->
      <div class="flex-1 min-w-[300px]">
        <label for="search" class="block text-sm font-medium text-gray-700 mb-2">
          Suche
        </label>
        <p-iconfield iconPosition="left" class="w-full">
          <p-inputicon class="pi pi-search"></p-inputicon>
          <input
            type="text"
            pInputText
            placeholder="Suche nach Name, Beschreibung, Inventarnummer..."
            [value]="searchQuery()"
            (input)="searchQuery.set($any($event.target).value)"
            class="w-full"
          />
        </p-iconfield>
      </div>

      <!-- Status Filter -->
      <div class="flex-1 min-w-[200px]">
        <label for="statusFilter" class="block text-sm font-medium text-gray-700 mb-2">
          Status
        </label>
        <p-select
          id="statusFilter"
          name="statusFilter"
          [options]="statusOptions"
          [(ngModel)]="statusFilterValue"
          (ngModelChange)="onStatusFilterChange($event)"
          optionLabel="label"
          optionValue="value"
          placeholder="Status waehlen"
          class="w-full"
        />
      </div>

      <!-- Bulk-Aktionen -->
      @if (pendingSelectedRequests().length > 0) {
        <div class="flex gap-2">
          <p-button
            label="Batch-Import ({{ pendingSelectedRequests().length }})"
            icon="pi pi-check"
            (onClick)="openBatchDialog()"
            severity="success"
            size="small"
          />
          <p-button
            label="Alle ablehnen ({{ pendingSelectedRequests().length }})"
            icon="pi pi-times"
            (onClick)="bulkReject()"
            severity="danger"
            size="small"
          />
        </div>
      }
    </div>
  </p-card>

  <!-- Import-Requests Tabelle -->
  <p-card class="shadow-sm">
    <p-table
      [value]="filteredRequests()"
      [loading]="isLoading()"
      [(selection)]="selectedRequests"
      dataKey="id"
      [paginator]="true"
      [rows]="10"
      [rowsPerPageOptions]="[5, 10, 25, 50]"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Zeige {first} bis {last} von {totalRecords} Eintraegen"
      class="p-datatable-sm"
    >
      <ng-template pTemplate="header">
        <tr>
          <th scope="col" style="width: 4rem">
            <p-tableHeaderCheckbox />
          </th>
          <th scope="col" pSortableColumn="id">
            ID <p-sortIcon field="id" />
          </th>
          <th scope="col" pSortableColumn="name">
            Name <p-sortIcon field="name" />
          </th>
          <th scope="col" pSortableColumn="invNumber">
            Inv-Nr <p-sortIcon field="invNumber" />
          </th>
          <th scope="col" pSortableColumn="location">
            Standort <p-sortIcon field="location" />
          </th>
          <th scope="col">
            Matching
          </th>
          <th scope="col" pSortableColumn="status">
            Status <p-sortIcon field="status" />
          </th>
          <th scope="col" pSortableColumn="createdAt">
            Erstellt am <p-sortIcon field="createdAt" />
          </th>
          <th scope="col" style="width: 10rem">Aktionen</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-request>
        <tr [class.bg-blue-50]="isNewRequest(request)">
          <td>
            <p-tableCheckbox [value]="request" />
          </td>
          <td>
            <div class="flex items-center gap-2">
              {{ request.id }}
              @if (isNewRequest(request)) {
                <p-chip label="NEU" class="text-xs" />
              }
            </div>
          </td>
          <td>
            <div class="font-medium">{{ request.name }}</div>
            @if (request.description) {
              <div class="text-sm text-gray-500 truncate max-w-xs">
                {{ request.description }}
              </div>
            }
          </td>
          <td>
            <code class="text-sm bg-gray-100 px-2 py-1 rounded">
              {{ request.invNumber }}
            </code>
          </td>
          <td>{{ request.location || '-' }}</td>
          <td>
            @if (request.hasMatchingProduct) {
              <p-tag
                [value]="request.matchingProductName"
                severity="info"
                icon="pi pi-link"
                pTooltip="Passendes Produkt gefunden"
                tooltipPosition="top"
              />
            } @else {
              <span class="text-gray-400">Kein Match</span>
            }
          </td>
          <td>
            <p-tag
              [value]="getStatusLabel(request.status)"
              [severity]="getStatusSeverity(request.status)"
            />
          </td>
          <td>{{ formatDate(request.createdAt) }}</td>
          <td>
            <div class="flex gap-1">
              @if (request.status === 'PENDING') {
                <p-button
                  icon="pi pi-check"
                  [rounded]="true"
                  [text]="true"
                  severity="success"
                  pTooltip="Importieren"
                  tooltipPosition="top"
                  (onClick)="openImportDialog(request)"
                />
                <p-button
                  icon="pi pi-times"
                  [rounded]="true"
                  [text]="true"
                  severity="danger"
                  pTooltip="Ablehnen"
                  tooltipPosition="top"
                  (onClick)="openRejectDialog(request)"
                />
              }
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="9" class="text-center py-8">
            <div class="flex flex-col items-center gap-3">
              <i class="pi pi-inbox text-6xl text-gray-300"></i>
              <p class="text-gray-500">Keine Import-Anfragen gefunden</p>
              <p-button
                label="Mock-Daten laden"
                icon="pi pi-refresh"
                (onClick)="refreshImports()"
                [outlined]="true"
              />
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>
</div>

<!-- Import Dialog -->
<p-dialog
  header="Import konfigurieren"
  [(visible)]="showImportDialog"
  [modal]="true"
  [style]="{ width: '600px' }"
  [contentStyle]="{ 'max-height': '70vh', 'overflow-y': 'auto' }"
  [focusOnShow]="false"
  [draggable]="false"
>
  @if (currentRequest()) {
    <div class="py-4 space-y-6">
      <!-- Item Info -->
      <div class="bg-gray-50 p-4 rounded-lg space-y-2">
        <div class="flex justify-between">
          <span class="font-medium">Name:</span>
          <span>{{ currentRequest()!.name }}</span>
        </div>
        <div class="flex justify-between">
          <span class="font-medium">Inv-Nr:</span>
          <span>{{ currentRequest()!.invNumber }}</span>
        </div>
        <div class="flex justify-between">
          <span class="font-medium">Standort:</span>
          <span>{{ currentRequest()!.location || '-' }}</span>
        </div>
      </div>

      <!-- Matching Product Hinweis -->
      @if (currentRequest()!.hasMatchingProduct) {
        <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg">
          <div class="flex items-center gap-2 text-blue-700">
            <i class="pi pi-info-circle"></i>
            <span class="font-medium">Passendes Produkt gefunden:</span>
            <span>{{ currentRequest()!.matchingProductName }}</span>
          </div>
        </div>
      }

      <!-- Import Type Auswahl -->
      <div class="space-y-3">
        <label class="block text-sm font-medium text-gray-700">Import-Typ</label>
        <div class="flex flex-col gap-3">
          <div class="flex items-center">
            <p-radioButton
              name="importType"
              value="EXISTING_PRODUCT"
              [(ngModel)]="importType"
              inputId="existingProduct"
            />
            <label for="existingProduct" class="ml-2">
              Zu bestehendem Produkt hinzufuegen
            </label>
          </div>
          <div class="flex items-center">
            <p-radioButton
              name="importType"
              value="NEW_PRODUCT"
              [(ngModel)]="importType"
              inputId="newProduct"
            />
            <label for="newProduct" class="ml-2">
              Als neues Produkt anlegen
            </label>
          </div>
        </div>
      </div>

      <!-- Felder fuer Bestehendes Produkt -->
      @if (importType() === 'EXISTING_PRODUCT') {
        <div class="space-y-4 border-t pt-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Produkt auswaehlen <span class="text-red-500">*</span>
            </label>
            <p-select
              [options]="products()"
              [(ngModel)]="selectedProductId"
              optionLabel="name"
              optionValue="id"
              placeholder="Produkt waehlen"
              [filter]="true"
              filterPlaceholder="Suchen..."
              class="w-full"
              name="productSelect"
              appendTo="body"
            >
              <ng-template let-product pTemplate="item">
                <div class="flex justify-between items-center w-full">
                  <span>{{ product.name }}</span>
                  @if (product.categoryName) {
                    <span class="text-sm text-gray-500">{{ product.categoryName }}</span>
                  }
                </div>
              </ng-template>
            </p-select>
          </div>
        </div>
      }

      <!-- Felder fuer Neues Produkt -->
      @if (importType() === 'NEW_PRODUCT') {
        <div class="space-y-4 border-t pt-4">
          <!-- Hinweis mit Link zur Produkterstellung -->
          <div class="bg-amber-50 border border-amber-200 p-4 rounded-lg">
            <div class="flex items-start gap-3">
              <i class="pi pi-info-circle text-amber-600 mt-0.5"></i>
              <div class="text-sm text-amber-800">
                <p class="font-medium mb-1">Kategorie oder Standort fehlt?</p>
                <p class="mb-2">
                  Falls die benoetigte Kategorie oder der Standort noch nicht existiert,
                  kannst du das Produkt direkt ueber die Produktverwaltung anlegen.
                </p>
                <a
                  routerLink="/admin/products"
                  class="inline-flex items-center gap-1 text-amber-700 hover:text-amber-900 font-medium"
                  (click)="showImportDialog.set(false)"
                >
                  <i class="pi pi-external-link"></i>
                  Zur Produktverwaltung
                </a>
              </div>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Kategorie <span class="text-red-500">*</span>
            </label>
            <p-select
              [options]="categories()"
              [(ngModel)]="selectedCategoryId"
              optionLabel="name"
              optionValue="id"
              placeholder="Kategorie waehlen"
              class="w-full"
              name="categorySelect"
              appendTo="body"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Standort <span class="text-red-500">*</span>
            </label>
            <p-select
              [options]="locations()"
              [(ngModel)]="selectedLocationId"
              optionLabel="roomNr"
              optionValue="id"
              placeholder="Standort waehlen"
              class="w-full"
              name="locationSelect"
              appendTo="body"
            />
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Preis/Tag (EUR)
              </label>
              <p-inputNumber
                [(ngModel)]="importPrice"
                mode="currency"
                currency="EUR"
                locale="de-DE"
                class="w-full"
                name="priceInput"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Max. Ausleihdauer (Tage)
              </label>
              <p-inputNumber
                [(ngModel)]="importExpiryDate"
                [min]="1"
                [max]="365"
                class="w-full"
                name="expiryInput"
              />
            </div>
          </div>
        </div>
      }
    </div>
  }

  <ng-template pTemplate="footer">
    <p-button
      label="Abbrechen"
      icon="pi pi-times"
      (onClick)="showImportDialog.set(false)"
      [text]="true"
    />
    <p-button
      label="Importieren"
      icon="pi pi-check"
      (onClick)="confirmImport()"
      severity="success"
      [disabled]="(importType() === 'NEW_PRODUCT' && (!selectedCategoryId || !selectedLocationId)) ||
                  (importType() === 'EXISTING_PRODUCT' && !selectedProductId)"
    />
  </ng-template>
</p-dialog>

<!-- Reject Dialog -->
<p-dialog
  header="Import ablehnen"
  [(visible)]="showRejectDialog"
  [modal]="true"
  [style]="{ width: '500px' }"
  [focusOnShow]="false"
  [draggable]="false"
>
  @if (currentRequest()) {
    <div class="py-4">
      <p class="mb-4">
        Moechten Sie folgenden Import ablehnen?
      </p>
      <div class="bg-gray-50 p-4 rounded-lg space-y-2 mb-4">
        <div class="flex justify-between">
          <span class="font-medium">Name:</span>
          <span>{{ currentRequest()!.name }}</span>
        </div>
        <div class="flex justify-between">
          <span class="font-medium">Inv-Nr:</span>
          <span>{{ currentRequest()!.invNumber }}</span>
        </div>
      </div>

      <label for="rejectReason" class="block text-sm font-medium text-gray-700 mb-2">
        Grund (optional)
      </label>
      <textarea
        pTextarea
        id="rejectReason"
        name="rejectReason"
        [(ngModel)]="rejectReason"
        rows="3"
        placeholder="Grund fuer die Ablehnung..."
        class="w-full">
      </textarea>
    </div>
  }

  <ng-template pTemplate="footer">
    <p-button
      label="Abbrechen"
      icon="pi pi-times"
      (onClick)="showRejectDialog.set(false)"
      [text]="true"
    />
    <p-button
      label="Ablehnen"
      icon="pi pi-times"
      (onClick)="confirmReject()"
      severity="danger"
    />
  </ng-template>
</p-dialog>

<!-- Batch Import Dialog -->
<p-dialog
  header="Batch-Import"
  [(visible)]="showBatchDialog"
  [modal]="true"
  [style]="{ width: '500px' }"
  [contentStyle]="{ 'max-height': '70vh', 'overflow-y': 'auto' }"
  [focusOnShow]="false"
  [draggable]="false"
>
  <div class="py-4 space-y-4">
    <p>
      <strong>{{ pendingSelectedRequests().length }}</strong> Items werden zu einem Produkt importiert.
    </p>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">
        Ziel-Produkt <span class="text-red-500">*</span>
      </label>
      <p-select
        [options]="products()"
        [(ngModel)]="batchProductId"
        optionLabel="name"
        optionValue="id"
        placeholder="Produkt waehlen"
        [filter]="true"
        filterPlaceholder="Suchen..."
        class="w-full"
        name="batchProductSelect"
        appendTo="body"
      />
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">
        Inventarnummer-Praefix (optional)
      </label>
      <input
        type="text"
        pInputText
        [(ngModel)]="batchInvPrefix"
        placeholder="z.B. VR"
        class="w-full"
        name="batchInvPrefix"
      />
      <p class="text-sm text-gray-500 mt-1">
        Leer lassen um InSy-Inventarnummern zu verwenden
      </p>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <p-button
      label="Abbrechen"
      icon="pi pi-times"
      (onClick)="showBatchDialog.set(false)"
      [text]="true"
    />
    <p-button
      label="Importieren"
      icon="pi pi-check"
      (onClick)="confirmBatchImport()"
      severity="success"
      [disabled]="!batchProductId"
    />
  </ng-template>
</p-dialog>

<!-- Toast -->
<p-toast />

<!-- Confirm Dialog -->
<p-confirmDialog />
