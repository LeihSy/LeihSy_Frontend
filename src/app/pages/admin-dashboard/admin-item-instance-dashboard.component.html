<div class="p-8 max-w-7xl mx-auto">
  <p-toast></p-toast>
  <p-confirmDialog></p-confirmDialog>

  <h1 class="text-3xl font-bold mb-4">Einzelne Gegenstände verwalten</h1>
  <p class="text-muted-foreground mb-6">
    Erstelle, bearbeite oder lösche einzelne physische Gegenstände zu jedem Produkt
  </p>

  @if (showItemForm()) {
    <p-card [header]="isEditMode() ? 'Gegenstand bearbeiten' : 'Neuen Gegenstand anlegen'" class="mb-6">
      <form [formGroup]="itemForm" (ngSubmit)="submitForm()" class="grid gap-4">

        @if (selectedProductForNewItem() && !isEditMode()) {
          <div class="bg-blue-50 p-3 rounded border border-blue-200">
            <p class="text-sm">
              <strong>Produkt:</strong> {{ selectedProductForNewItem()!.name }}
              <br>
              <strong>Kategorie:</strong> {{ selectedProductForNewItem()!.category?.name || 'N/A' }}
            </p>
          </div>
        }

        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block font-semibold">
              <span class="block mb-2">Inventarnummer Präfix *</span>
              <input pInputText formControlName="invNumber" class="w-full"
                     placeholder="z.B. VR-PRO"
                     (input)="onInventoryPrefixChange()"
                     pTooltip="Basisname für die Inventarnummer (Zahl wird automatisch hinzugefügt)" />
            </label>
            @if (generatedInventoryNumbers().length > 0 && !isEditMode()) {
              <small class="text-gray-600 mt-1 block">
                Vorschau: {{ generatedInventoryNumbers()[0] }}
                @if (generatedInventoryNumbers().length > 1) {
                  bis {{ generatedInventoryNumbers()[generatedInventoryNumbers().length - 1] }}
                }
              </small>
            }
          </div>
        </div>

        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block font-semibold">
              <span class="block mb-2">Besitzer User ID</span>
              <p-inputNumber formControlName="ownerId"
                             [useGrouping]="false"
                             class="w-full"
                             placeholder="z.B. 1"
                             (onInput)="onOwnerIdChange()">
              </p-inputNumber>
            </label>
            @if (ownerIdDisplayValue() && !itemForm.get('ownerName')?.value) {
              <small [class]="isLoadingOwnerId() ? 'text-gray-400' : (ownerFound() ? 'text-green-600' : 'text-red-600')" class="mt-1 block">
                @if (isLoadingOwnerId()) {
                  <i class="pi pi-spin pi-spinner mr-1"></i>Lädt...
                } @else if (ownerFound()) {
                  <i class="pi pi-check mr-1"></i>{{ ownerIdDisplayValue() }}
                } @else {
                  <i class="pi pi-times mr-1"></i>{{ ownerIdDisplayValue() }}
                }
              </small>
            }
          </div>

          <div>
            <label class="block font-semibold">
              <span class="block mb-2">Besitzer Benutzername *</span>
              <input pInputText formControlName="ownerName"
                     class="w-full"
                     placeholder="Username"
                     (input)="onOwnerNameChange()" />
            </label>
            @if (ownerNameDisplayValue() && itemForm.get('ownerName')?.value) {
              <small [class]="isLoadingOwnerName() ? 'text-gray-400' : (ownerFound() ? 'text-green-600' : 'text-red-600')" class="mt-1 block">
                @if (isLoadingOwnerName()) {
                  <i class="pi pi-spin pi-spinner mr-1"></i>Lädt...
                } @else if (ownerFound()) {
                  <i class="pi pi-check mr-1"></i>{{ ownerNameDisplayValue() }}
                } @else {
                  <i class="pi pi-times mr-1"></i>{{ ownerNameDisplayValue() }}
                }
              </small>
            }
          </div>
        </div>

        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block font-semibold">
              <span class="block mb-2">Verleiher User ID *</span>
              <p-inputNumber formControlName="lenderId"
                             [useGrouping]="false"
                             class="w-full"
                             placeholder="z.B. 1"
                             (onInput)="onLenderIdChange()">
              </p-inputNumber>
            </label>
            @if (lenderDisplayValue() && !itemForm.get('lenderName')?.value) {
              <small [class]="isLoadingLender() ? 'text-gray-400' : (lenderDisplayValue().includes('nicht gefunden') ? 'text-red-600' : 'text-green-600')" class="mt-1 block">
                @if (isLoadingLender()) {
                  <i class="pi pi-spin pi-spinner mr-1"></i>Lädt...
                } @else if (lenderDisplayValue().includes('nicht gefunden')) {
                  <i class="pi pi-times mr-1"></i>{{ lenderDisplayValue() }}
                } @else {
                  <i class="pi pi-check mr-1"></i>{{ lenderDisplayValue() }}
                }
              </small>
            }
          </div>

          <div>
            <label class="block font-semibold">
              <span class="block mb-2">Verleiher Benutzername *</span>
              <input pInputText formControlName="lenderName"
                     class="w-full"
                     placeholder="Username"
                     (input)="onLenderNameChange()" />
            </label>
            @if (lenderDisplayValue() && itemForm.get('lenderName')?.value) {
              <small [class]="isLoadingLender() ? 'text-gray-400' : (lenderDisplayValue().includes('nicht gefunden') ? 'text-red-600' : 'text-green-600')" class="mt-1 block">
                @if (isLoadingLender()) {
                  <i class="pi pi-spin pi-spinner mr-1"></i>Lädt...
                } @else if (lenderDisplayValue().includes('nicht gefunden')) {
                  <i class="pi pi-times mr-1"></i>{{ lenderDisplayValue() }}
                } @else {
                  <i class="pi pi-check mr-1"></i>{{ lenderDisplayValue() }}
                }
              </small>
            }
          </div>
        </div>

        @if (!isEditMode()) {
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block font-semibold">
                <span class="block mb-2">Anzahl zu erstellender Instanzen</span>
                <p-inputNumber formControlName="quantity"
                               [min]="1"
                               [max]="100"
                               [showButtons]="true"
                               class="w-full"
                               placeholder="1"
                               (onInput)="onQuantityChange()">
                </p-inputNumber>
              </label>
              <small class="text-gray-600 mt-1 block">
                Es werden {{ itemForm.get('quantity')?.value || 1 }} Instanzen erstellt
              </small>
            </div>
            <div></div>
          </div>
        }

        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block mb-2 font-semibold">Produkt *</label>
            <p-select
              [options]="allProducts()"
              optionLabel="name"
              optionValue="id"
              placeholder="Produkt wählen"
              formControlName="productId"
              class="w-full"
              [disabled]="isEditMode()">
            </p-select>
          </div>

          <div>
            <label class="block mb-2 font-semibold">Verfügbar</label>
            <p-toggleButton
              formControlName="available"
              onLabel="Verfügbar"
              offLabel="Nicht verfügbar"
              onIcon="pi pi-check"
              offIcon="pi pi-times"
              class="w-full">
            </p-toggleButton>
          </div>
        </div>

        <div class="flex gap-2">
          <button pButton type="submit"
                  [label]="isEditMode() ? 'Aktualisieren' : ('Erstellen (' + (itemForm.get('quantity')?.value || 1) + 'x)')"
                  [disabled]="itemForm.invalid"></button>
          <button pButton type="button" label="Abbrechen"
                  class="p-button-secondary" (click)="resetForm()"></button>
        </div>
      </form>
    </p-card>
  }

  <p-card header="Produkte und ihre Gegenstände">

    <div class="mb-4">
      <p-iconfield iconPosition="left">
        <p-inputicon class="pi pi-search"></p-inputicon>
        <input type="text" pInputText placeholder="Suche nach Produktname, Kategorie..."
               (input)="onSearchChange($any($event.target).value)"
               class="w-full" />
      </p-iconfield>
    </div>

    <div class="space-y-4">
      @for (productData of productsWithItems(); track productData.product.id) {
        <div class="border rounded-lg overflow-hidden bg-white">

          <button
            type="button"
            class="product-header flex justify-between items-center p-4 cursor-pointer hover:bg-gray-50 transition-colors w-full text-left"
            (click)="toggleProductExpansion(productData.product.id)">

            <div class="flex items-center gap-3 flex-1">

              <i [class]="isProductExpanded(productData.product.id) ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
                 class="text-gray-500"></i>

              <div>
                <h3 class="text-lg font-bold">{{ productData.product.name }}</h3>
                <p class="text-xs text-gray-600">
                  <strong>Kategorie:</strong> {{ productData.product.category?.name || 'N/A' }} |
                  <strong>Standort:</strong> {{ productData.product.location?.roomNr || 'N/A' }}
                </p>
              </div>
            </div>

            <div class="flex items-center gap-3">
              <span class="badge badge-info">
                {{ productData.availableCount }} / {{ productData.totalCount }} verfügbar
              </span>
              <button pButton icon="pi pi-plus"
                      type="button"
                      class="p-button-sm p-button-rounded"
                      (click)="addItemForProduct(productData.product); $event.stopPropagation()"
                      pTooltip="Neue Instanz hinzufügen"></button>
            </div>
          </button>

          @if (isProductExpanded(productData.product.id)) {
            <div class="border-t p-4 bg-gray-50">
              @if (productData.product.description) {
                <p class="text-sm text-gray-500 mb-3">{{ productData.product.description }}</p>
              }

              @if (productData.items.length > 0) {
                <p-table [value]="productData.items"
                         class="p-datatable-sm"
                         [scrollable]="true">

                  <ng-template pTemplate="header">
                    <tr>
                      <th scope="col">ID</th>
                      <th scope="col">Inventarnummer</th>
                      <th scope="col">Besitzer</th>
                      <th scope="col">Verleiher</th>
                      <th scope="col">Status</th>
                      <th style="width: 150px;" scope="col">Aktionen</th>
                    </tr>
                  </ng-template>

                  <ng-template pTemplate="body" let-item>
                    <tr>
                      <td>{{ item.id }}</td>
                      <td>{{ item.invNumber }}</td>
                      <td>{{ getOwnerDisplay(item.owner) }}</td>
                      <td>{{ getLenderDisplay(item.lenderId) }}</td>
                      <td>
                        <span [class]="item.available ? 'badge badge-available' : 'badge badge-unavailable'">
                          {{ item.available ? 'Verfügbar' : 'Nicht verfügbar' }}
                        </span>
                      </td>
                      <td>
                        <div class="flex gap-2">
                          <button pButton icon="pi pi-pencil"
                                  class="p-button-sm p-button-warning"
                                  (click)="editItem(item)"
                                  pTooltip="Bearbeiten"></button>
                          <button pButton icon="pi pi-trash"
                                  class="p-button-sm p-button-danger"
                                  (click)="deleteItem(item)"
                                  pTooltip="Löschen"></button>
                        </div>
                      </td>
                    </tr>
                  </ng-template>

                  <ng-template pTemplate="emptymessage">
                    <tr>
                      <td colspan="5" class="text-center text-gray-500 py-2">
                        Keine Instanzen vorhanden
                      </td>
                    </tr>
                  </ng-template>
                </p-table>
              } @else {
                <div class="text-center text-gray-500 py-4 bg-white rounded border">
                  <p class="text-sm">Noch keine Instanzen für dieses Produkt angelegt.</p>
                  <p class="text-xs mt-1">Klicken Sie auf das Plus-Symbol, um die erste Instanz zu erstellen.</p>
                </div>
              }
            </div>
          }

        </div>
      }
    </div>

    @if (productsWithItems().length === 0) {
      <div class="text-center text-gray-500 py-8">
        @if (isLoading()) {
          Lade Produkte...
        } @else if (searchQuery()) {
          Keine Produkte gefunden für "{{ searchQuery() }}"
        } @else {
          Keine Produkte vorhanden
        }
      </div>
    }

  </p-card>
</div>

