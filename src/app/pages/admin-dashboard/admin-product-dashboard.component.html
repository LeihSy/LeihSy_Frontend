<div class="p-8 max-w-7xl mx-auto">
  <p-toast></p-toast>
  <p-confirmDialog></p-confirmDialog>

  <h1 class="text-3xl font-bold mb-4">Produktgruppen verwalten</h1>
  <p class="text-muted-foreground mb-6">Erstelle, bearbeite oder lösche Produktgruppen</p>

  <p-card [header]="isEditMode() ? 'Produkt bearbeiten' : 'Neues Produkt anlegen'" class="mb-6">
    <form [formGroup]="itemForm" (ngSubmit)="submitForm()">

      <p-tabs value="0">
        <p-tablist>
          <p-tab value="0">Allgemeine Informationen</p-tab>
          <p-tab value="1">Produkt Details</p-tab>
        </p-tablist>

        <p-tabpanels>
          <p-tabpanel value="0">
            <div class="grid gap-4 mt-4">

            <div class="grid md:grid-cols-2 gap-4">
              <div>
                <label class="block font-semibold">
                  <span class="block mb-2">Name *</span>
                  <input pInputText formControlName="name" class="w-full"
                         placeholder="z.B. Canon EOS R5" />
                </label>
              </div>

              <div>
                <label class="block font-semibold">
                  <span class="block mb-2">Kategorie *</span>
                  <p-select
                    [options]="allCategories()"
                    optionLabel="name"
                    optionValue="id"
                    placeholder="Kategorie wählen"
                    formControlName="categoryId"
                    class="w-full">
                  </p-select>
                  @if (allCategories().length === 0) {
                    <small class="text-orange-600 mt-1 block">
                      <i class="pi pi-exclamation-triangle mr-1"></i>
                      Keine Kategorien verfügbar. Bitte Backend überprüfen oder Kategorien in der Datenbank anlegen.
                    </small>
                  }
                </label>
              </div>
            </div>

            <div>
              <label class="block font-semibold">
                <span class="block mb-2">Beschreibung</span>
                <textarea rows="4" formControlName="description" class="w-full"
                          placeholder="Detaillierte Beschreibung des Produkts..."
                          style="border: 1px solid #d1d5db; border-radius: 6px; padding: 0.5rem;"></textarea>
              </label>
            </div>

              <div>
                <label class="block font-semibold">
                  <span class="block mb-2">Produktbild</span>

                  @if (imagePreview()) {
                    <div class="mb-3">
                      <img [src]="imagePreview()" alt="Preview"
                           class="max-w-xs rounded border border-gray-300" />
                      <button pButton icon="pi pi-times"
                              label="Bild entfernen"
                              class="p-button-sm p-button-danger mt-2"
                              type="button"
                              (click)="removeImage()"></button>
                    </div>
                  }

                  <input type="file"
                         accept="image/jpeg,image/png,image/webp"
                         (change)="onFileSelected($event)"
                         class="block w-full text-sm text-gray-500
                              file:mr-4 file:py-2 file:px-4
                              file:rounded file:border-0
                              file:text-sm file:font-semibold
                              file:bg-blue-50 file:text-blue-700
                              hover:file:bg-blue-100
                              cursor-pointer" />
                  <small class="text-gray-500">JPG, PNG oder WebP, max. 5MB</small>
                </label>
              </div>

            <div>
              <label class="block font-semibold">
                <span class="block mb-2">Zubehör</span>
                <input pInputText formControlName="accessories" class="w-full"
                       placeholder='["Controller", "Kabel", "Netzteil"]' />
              </label>
            </div>

          </div>
          </p-tabpanel>

          <p-tabpanel value="1">
            <div class="grid gap-4 mt-4">

            <div class="grid md:grid-cols-2 gap-4">
              <div>
                <label class="block font-semibold">
                  <span class="block mb-2">Max. Ausleihdauer (Tage) *</span>
                  <p-inputNumber formControlName="expiryDate"
                                 [min]="1"
                                 [showButtons]="true"
                                 class="w-full"
                                 placeholder="z.B. 7">
                  </p-inputNumber>
                </label>
              </div>

              <div>
                <label class="block font-semibold">
                  <span class="block mb-2">Preis / Tagessatz (€) *</span>
                  <p-inputNumber formControlName="price"
                                 [min]="0"
                                 [minFractionDigits]="2"
                                 [maxFractionDigits]="2"
                                 mode="currency"
                                 currency="EUR"
                                 [showButtons]="true"
                                 class="w-full">
                  </p-inputNumber>
                </label>
              </div>
            </div>

            <div class="grid md:grid-cols-2 gap-4">
              <div>
                <label class="block font-semibold">
                  <span class="block mb-2">Standort ID *</span>
                  <p-inputNumber formControlName="locationId"
                                 [min]="1"
                                 [showButtons]="true"
                                 class="w-full"
                                 placeholder="z.B. 1">
                  </p-inputNumber>
                </label>
              </div>

              <div>
                <label class="block font-semibold">
                  <span class="block mb-2">Raum / Standort *</span>
                  <input pInputText formControlName="locationRoomNr"
                         class="w-full" placeholder="z.B. F01.204" />
                </label>
              </div>
            </div>


            <div class="flex gap-2 mt-6">
              <button pButton type="submit"
                      [label]="isEditMode() ? 'Aktualisieren' : 'Erstellen'"
                      [disabled]="itemForm.invalid"></button>

              @if (isEditMode()) {
                <button pButton type="button" label="Abbrechen"
                        class="p-button-secondary" (click)="resetForm()"></button>
              }
            </div>

          </div>
          </p-tabpanel>

        </p-tabpanels>
      </p-tabs>

    </form>
  </p-card>

  <p-card header="Vorhandene Produkte">

    <div class="mb-4">
      <p-iconfield iconPosition="left">
        <p-inputicon styleClass="pi pi-search"></p-inputicon>
        <input type="text" pInputText placeholder="Suche nach Name, Beschreibung, Kategorie..."
               (input)="onSearchChange($any($event.target).value)"
               class="w-full" />
      </p-iconfield>
    </div>

    <p-table [value]="filteredProducts()" [loading]="isLoading()"
             styleClass="p-datatable-sm" [paginator]="true" [rows]="10"
             [scrollable]="true" scrollHeight="600px">

      <ng-template pTemplate="header">
        <tr>
          <th scope="col">ID</th>
          <th scope="col">Name</th>
          <th scope="col">Kategorie</th>
          <th scope="col">Standort</th>
          <th scope="col">Preis/Tag</th>
          <th style="width: 150px;" scope="col">Aktionen</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-product>
        <tr>
          <td>{{ product.id }}</td>
          <td>
            <strong>{{ product.name }}</strong>
            <br>
            <small class="text-gray-500">{{ product.description | slice:0:50 }}{{ product.description.length > 50 ? '...' : '' }}</small>
          </td>
          <td>{{ product.category?.name || 'N/A' }}</td>
          <td>{{ product.location?.roomNr || '-' }}</td>
          <td>{{ product.price | number:'1.2-2' }} €</td>
          <td>
            <div class="flex gap-2">
              <button pButton icon="pi pi-pencil"
                      class="p-button-sm p-button-warning"
                      (click)="editProduct(product)"
                      pTooltip="Bearbeiten"></button>
              <button pButton icon="pi pi-trash"
                      class="p-button-sm p-button-danger"
                      (click)="deleteProduct(product)"
                      pTooltip="Löschen"></button>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="6" class="text-center text-gray-500 py-4">
            @if (searchQuery()) {
              Keine Produkte gefunden für "{{ searchQuery() }}"
            } @else {
              Keine Produkte vorhanden
            }
          </td>
        </tr>
      </ng-template>

    </p-table>

  </p-card>
</div>

