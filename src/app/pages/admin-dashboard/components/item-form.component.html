<p-card [header]="isEditMode ? 'Gegenstand bearbeiten' : 'Neuen Gegenstand anlegen'" class="mb-6">
  <form [formGroup]="itemForm" (ngSubmit)="submitForm()" class="grid gap-4">

    @if (selectedProduct && !isEditMode) {
      <div class="bg-blue-50 p-3 rounded border border-blue-200">
        <p class="text-sm">
          <strong>Produkt:</strong> {{ selectedProduct.name }}
          <br>
          <strong>Kategorie:</strong> {{ selectedProduct.category?.name || 'N/A' }}
        </p>
      </div>
    }

    <div class="grid md:grid-cols-2 gap-4">
      <div>
        <label class="block font-semibold">
          <span class="block mb-2">Inventarnummer Präfix *</span>
          <input pInputText formControlName="invNumber" class="w-full"
                 placeholder="z.B. VR-PRO"
                 (input)="onInventoryPrefixChange()"
                 pTooltip="Basisname für die Inventarnummer (Zahl wird automatisch hinzugefügt)" />
        </label>
        @if (generatedInventoryNumbers.length > 0 && !isEditMode) {
          <small class="text-gray-600 mt-1 block">
            Vorschau: {{ generatedInventoryNumbers[0] }}
            @if (generatedInventoryNumbers.length > 1) {
              bis {{ generatedInventoryNumbers[generatedInventoryNumbers.length - 1] }}
            }
          </small>
        }
      </div>
    </div>

    <div class="grid md:grid-cols-2 gap-4">
      <div>
        <label class="block font-semibold">
          <span class="block mb-2">Besitzer User ID</span>
          <p-inputNumber formControlName="ownerId"
                         [useGrouping]="false"
                         class="w-full"
                         placeholder="z.B. 1"
                         (onInput)="onOwnerIdChange()">
          </p-inputNumber>
        </label>
        @if (ownerIdDisplayValue() && !itemForm.get('ownerName')?.value) {
          <small [class]="isLoadingOwnerId() ? 'text-gray-400' : (ownerFound() ? 'text-green-600' : 'text-red-600')" class="mt-1 block">
            @if (isLoadingOwnerId()) {
              <i class="pi pi-spin pi-spinner mr-1"></i>Lädt...
            } @else if (ownerFound()) {
              <i class="pi pi-check mr-1"></i>{{ ownerIdDisplayValue() }}
            } @else {
              <i class="pi pi-times mr-1"></i>{{ ownerIdDisplayValue() }}
            }
          </small>
        }
      </div>

      <div>
        <label class="block font-semibold">
          <span class="block mb-2">Besitzer Benutzername *</span>
          <input pInputText formControlName="ownerName"
                 class="w-full"
                 placeholder="Username"
                 (input)="onOwnerNameChange()" />
        </label>
        @if (ownerNameDisplayValue() && itemForm.get('ownerName')?.value) {
          <small [class]="isLoadingOwnerName() ? 'text-gray-400' : (ownerFound() ? 'text-green-600' : 'text-red-600')" class="mt-1 block">
            @if (isLoadingOwnerName()) {
              <i class="pi pi-spin pi-spinner mr-1"></i>Lädt...
            } @else if (ownerFound()) {
              <i class="pi pi-check mr-1"></i>{{ ownerNameDisplayValue() }}
            } @else {
              <i class="pi pi-times mr-1"></i>{{ ownerNameDisplayValue() }}
            }
          </small>
        }
      </div>
    </div>

    <div class="grid md:grid-cols-2 gap-4">
      <div>
        <label class="block font-semibold">
          <span class="block mb-2">Verleiher User ID *</span>
          <p-inputNumber formControlName="lenderId"
                         [useGrouping]="false"
                         class="w-full"
                         placeholder="z.B. 1"
                         (onInput)="onLenderIdChange()">
          </p-inputNumber>
        </label>
        @if (lenderDisplayValue() && !itemForm.get('lenderName')?.value) {
          <small [class]="isLoadingLender() ? 'text-gray-400' : (lenderDisplayValue().includes('nicht gefunden') ? 'text-red-600' : 'text-green-600')" class="mt-1 block">
            @if (isLoadingLender()) {
              <i class="pi pi-spin pi-spinner mr-1"></i>Lädt...
            } @else if (lenderDisplayValue().includes('nicht gefunden')) {
              <i class="pi pi-times mr-1"></i>{{ lenderDisplayValue() }}
            } @else {
              <i class="pi pi-check mr-1"></i>{{ lenderDisplayValue() }}
            }
          </small>
        }
      </div>

      <div>
        <label class="block font-semibold">
          <span class="block mb-2">Verleiher Benutzername *</span>
          <input pInputText formControlName="lenderName"
                 class="w-full"
                 placeholder="Username"
                 (input)="onLenderNameChange()" />
        </label>
        @if (lenderDisplayValue() && itemForm.get('lenderName')?.value) {
          <small [class]="isLoadingLender() ? 'text-gray-400' : (lenderDisplayValue().includes('nicht gefunden') ? 'text-red-600' : 'text-green-600')" class="mt-1 block">
            @if (isLoadingLender()) {
              <i class="pi pi-spin pi-spinner mr-1"></i>Lädt...
            } @else if (lenderDisplayValue().includes('nicht gefunden')) {
              <i class="pi pi-times mr-1"></i>{{ lenderDisplayValue() }}
            } @else {
              <i class="pi pi-check mr-1"></i>{{ lenderDisplayValue() }}
            }
          </small>
        }
      </div>
    </div>

    @if (!isEditMode) {
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="block font-semibold">
            <span class="block mb-2">Anzahl zu erstellender Instanzen</span>
            <p-inputNumber formControlName="quantity"
                           [min]="1"
                           [max]="100"
                           [showButtons]="true"
                           class="w-full"
                           placeholder="1"
                           (onInput)="onQuantityChange()">
            </p-inputNumber>
          </label>
          <small class="text-gray-600 mt-1 block">
            Es werden {{ itemForm.get('quantity')?.value || 1 }} Instanzen erstellt
          </small>
        </div>
        <div></div>
      </div>
    }

    <div class="grid md:grid-cols-2 gap-4">
      <div>
        <label class="block mb-2 font-semibold">Produkt *</label>
        <p-select
          [options]="products"
          optionLabel="name"
          optionValue="id"
          placeholder="Produkt wählen"
          formControlName="productId"
          class="w-full"
          [disabled]="isEditMode">
        </p-select>
      </div>

      <div>
        <label class="block mb-3 font-semibold">Verfügbarkeit *</label>
        <div class="flex flex-col gap-3">
          <div class="flex items-center">
            <p-radioButton
              name="availability"
              value="true"
              inputId="available-yes"
              [(ngModel)]="availabilityValue"
              [ngModelOptions]="{standalone: true}"
              (onClick)="onAvailableChange(true)">
            </p-radioButton>
            <label for="available-yes" class="ml-2 cursor-pointer">
              <span class="font-medium">Verfügbar</span>
            </label>
          </div>
          <div class="flex items-center">
            <p-radioButton
              name="availability"
              value="false"
              inputId="available-no"
              [(ngModel)]="availabilityValue"
              [ngModelOptions]="{standalone: true}"
              (onClick)="onAvailableChange(false)">
            </p-radioButton>
            <label for="available-no" class="ml-2 cursor-pointer">
              <span class="font-medium">Nicht verfügbar</span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <div class="flex gap-2">
      <button pButton type="submit"
              [label]="isEditMode ? 'Aktualisieren' : ('Erstellen (' + (itemForm.get('quantity')?.value || 1) + 'x)')"
              [disabled]="itemForm.invalid"></button>
      <button pButton type="button" label="Abbrechen"
              class="p-button-secondary" (click)="resetForm()"></button>
    </div>
  </form>
</p-card>

