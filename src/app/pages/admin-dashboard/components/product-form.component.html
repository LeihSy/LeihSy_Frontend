<p-card [header]="isEditMode ? 'Produkt bearbeiten' : 'Neues Produkt anlegen'" class="mb-6">
  <form [formGroup]="itemForm" (ngSubmit)="submitForm()">

    <p-tabs value="0">
      <p-tablist>
        <p-tab value="0">Allgemeine Informationen</p-tab>
        <p-tab value="1">Produkt Details</p-tab>
      </p-tablist>

      <p-tabpanels>
        <p-tabpanel value="0">
          <div class="grid gap-4 mt-4">

            <div class="grid md:grid-cols-2 gap-4">
              <div>
                <label class="block font-semibold">
                  <span class="block mb-2">Name *</span>
                  <input pInputText formControlName="name" class="w-full"
                         placeholder="z.B. Canon EOS R5" />
                </label>
              </div>

              <div>
                <label class="block font-semibold">
                  <span class="block mb-2">Kategorie *</span>
                  <p-select
                    [options]="categories"
                    optionLabel="name"
                    optionValue="id"
                    placeholder="Kategorie wählen"
                    formControlName="categoryId"
                    class="w-full">
                  </p-select>
                  @if (categories.length === 0) {
                    <small class="text-orange-600 mt-1 block">
                      <i class="pi pi-exclamation-triangle mr-1"></i>
                      Keine Kategorien verfügbar. Bitte Backend überprüfen oder Kategorien in der Datenbank anlegen.
                    </small>
                  }
                </label>
              </div>
            </div>

            <div>
              <label class="block font-semibold">
                <span class="block mb-2">Beschreibung</span>
                <textarea rows="4" formControlName="description" class="w-full"
                          placeholder="Detaillierte Beschreibung des Produkts..."
                          style="border: 1px solid #d1d5db; border-radius: 6px; padding: 0.5rem;"></textarea>
              </label>
            </div>

            <div>
              <label class="block font-semibold">
                <span class="block mb-2">Produktbild</span>

                @if (imagePreview()) {
                  <div class="mb-3">
                    <img [src]="imagePreview()" alt="Preview"
                         class="max-w-xs rounded border border-gray-300" />
                    <button pButton icon="pi pi-times"
                            label="Bild entfernen"
                            class="p-button-sm p-button-danger mt-2"
                            type="button"
                            (click)="removeImage()"></button>
                  </div>
                }

                <input type="file"
                       accept="image/jpeg,image/png,image/webp"
                       (change)="onFileSelected($event)"
                       class="block w-full text-sm text-gray-500
                            file:mr-4 file:py-2 file:px-4
                            file:rounded file:border-0
                            file:text-sm file:font-semibold
                            file:bg-blue-50 file:text-blue-700
                            hover:file:bg-blue-100
                            cursor-pointer" />
                <small class="text-gray-500">JPG, PNG oder WebP, max. 5MB</small>
              </label>
            </div>

            <div>
              <label class="block font-semibold">
                <span class="block mb-2">Zubehör</span>
                <input pInputText formControlName="accessories" class="w-full"
                       placeholder='["Controller", "Kabel", "Netzteil"]' />
              </label>
            </div>

          </div>
        </p-tabpanel>

        <p-tabpanel value="1">
          <div class="grid gap-4 mt-4">

            <div class="grid md:grid-cols-2 gap-4">
              <div>
                <label class="block font-semibold">
                  <span class="block mb-2">Max. Ausleihdauer (Tage) *</span>
                  <p-inputNumber formControlName="expiryDate"
                                 [min]="1"
                                 [showButtons]="true"
                                 class="w-full"
                                 placeholder="z.B. 7">
                  </p-inputNumber>
                </label>
              </div>

              <div>
                <label class="block font-semibold">
                  <span class="block mb-2">Preis / Tagessatz (€) *</span>
                  <p-inputNumber formControlName="price"
                                 [min]="0"
                                 [minFractionDigits]="2"
                                 [maxFractionDigits]="2"
                                 mode="currency"
                                 currency="EUR"
                                 [showButtons]="true"
                                 class="w-full">
                  </p-inputNumber>
                </label>
              </div>
            </div>

            <div class="grid md:grid-cols-2 gap-4">
              <div>
                <label class="block font-semibold">
                  <span class="block mb-2">Raumnummer *</span>
                  <input pInputText formControlName="locationRoomNr"
                         class="w-full"
                         placeholder="z.B. F01.204"
                         (input)="onLocationRoomNrChange()" />
                  @if (locationDisplayValue()) {
                    <small [class]="isLoadingLocation() ? 'text-gray-400' : 'text-green-600'" class="mt-1 block">
                      @if (isLoadingLocation()) {
                        <i class="pi pi-spin pi-spinner mr-1"></i>Lädt...
                      } @else if (locationExists()) {
                        <i class="pi pi-check mr-1"></i>{{ locationDisplayValue() }} (Existiert bereits)
                      } @else {
                        <i class="pi pi-info-circle mr-1"></i>{{ locationDisplayValue() }} (Wird neu angelegt)
                      }
                    </small>
                  }
                </label>
              </div>

              <div>
                <label class="block font-semibold">
                  <span class="block mb-2">Location ID</span>
                  <p-inputNumber formControlName="locationId"
                                 [useGrouping]="false"
                                 class="w-full"
                                 [disabled]="true"
                                 placeholder="Wird automatisch gesetzt">
                  </p-inputNumber>
                  <small class="text-gray-600 mt-1 block">
                    Wird automatisch aus Raumnummer ermittelt
                  </small>
                </label>
              </div>
            </div>

            <div class="flex gap-2 mt-6">
              <button pButton type="submit"
                      [label]="isEditMode ? 'Aktualisieren' : 'Erstellen'"
                      [disabled]="itemForm.invalid"></button>

              @if (isEditMode) {
                <button pButton type="button" label="Abbrechen"
                        class="p-button-secondary" (click)="resetForm()"></button>
              }
            </div>

          </div>
        </p-tabpanel>

      </p-tabpanels>
    </p-tabs>

  </form>
</p-card>

