<p-toast position="bottom-right"></p-toast>

<div class="min-h-[calc(100vh-4rem)] bg-gray-50 p-6">
  <div class="max-w-7xl mx-auto">
    
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
      <div>
        <h1 class="text-2xl font-bold text-[#2c3e7a]">Anfragen</h1>
        <p class="text-sm text-gray-500 mt-1">
          Verwalten Sie eingehende Buchungsanfragen für Ihre Geräte.
        </p>
      </div>
      
      <div class="flex gap-3">
        <div class="bg-white px-4 py-2 rounded border border-gray-200 shadow-sm flex flex-col items-center">
          <span class="text-xs text-gray-500 font-medium uppercase tracking-wider">Offen</span>
          <span class="text-xl font-bold text-orange-600">{{ pendingCount() }}</span>
        </div>
        </div>
    </div>

    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm mb-6 flex flex-col xl:flex-row gap-4 justify-between">
      
      <div class="relative flex-1">
        <i class="pi pi-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
        <input 
            pInputText 
            type="text" 
            placeholder="Student, Gerät oder Inv-Nr suchen..." 
            class="w-full pl-10"
            [(ngModel)]="searchQuery"
        >
      </div>

      <div class="flex flex-col sm:flex-row gap-3">
        <p-select 
            [options]="campusOptions" 
            [(ngModel)]="campusFilter" 
            optionLabel="label" 
            optionValue="value"
            class="w-full sm:w-48"
        ></p-select>

        <p-select 
            [options]="sortOptions" 
            [(ngModel)]="sortBy" 
            optionLabel="label" 
            optionValue="value"
            class="w-full sm:w-48"
        ></p-select>
      </div>
    </div>

    <div class="flex gap-6 border-b border-gray-200 mb-6">
      <button 
        class="pb-3 px-1 text-sm font-medium transition-colors border-b-2"
        [class.border-[#2c3e7a]]="tab === 'pending'"
        [class.text-[#2c3e7a]]="tab === 'pending'"
        [class.border-transparent]="tab !== 'pending'"
        [class.text-gray-500]="tab !== 'pending'"
        (click)="tab = 'pending'"
      >
        Offene Anfragen ({{ filteredPending().length }})
      </button>

      <button 
        class="pb-3 px-1 text-sm font-medium transition-colors border-b-2"
        [class.border-[#2c3e7a]]="tab === 'done'"
        [class.text-[#2c3e7a]]="tab === 'done'"
        [class.border-transparent]="tab !== 'done'"
        [class.text-gray-500]="tab !== 'done'"
        (click)="tab = 'done'"
      >
        Erledigt / Historie ({{ filteredDone().length }})
      </button>
    </div>

    @if (tab === 'pending') {
      <div class="bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm">
        <p-table [value]="filteredPending()" [tableStyle]="{ 'min-width': '60rem' }">
          <ng-template pTemplate="header">
            <tr>
              <th class="w-[25%]">Student</th>
              <th class="w-[25%]">Gerät</th>
              <th class="w-[15%]">Zeitraum</th>
              <th class="w-[10%]">Campus</th>
              <th class="w-[25%] text-right">Aktionen</th>
            </tr>
          </ng-template>

          <ng-template pTemplate="body" let-req>
            <tr class="hover:bg-gray-50">
              <td>
                <div class="flex flex-col">
                  <span class="font-semibold text-gray-900">{{ req.studentName }}</span>
                  <span class="text-xs text-gray-500">{{ req.studentId }}</span>
                </div>
              </td>
              
              <td>
                <div class="flex flex-col">
                  <span class="font-medium text-gray-900">{{ req.productName }}</span>
                  <span class="text-xs text-gray-500 font-mono bg-gray-100 px-1.5 py-0.5 rounded w-fit mt-1">
                    {{ req.inventoryNumber }}
                  </span>
                </div>
              </td>

              <td>
                <div class="text-sm text-gray-700">
                  <div class="font-medium">{{ formatDate(req.fromDate) }}</div>
                  <div class="text-gray-400 text-xs">bis</div>
                  <div class="font-medium">{{ formatDate(req.toDate) }}</div>
                </div>
              </td>

              <td>
                <span class="bg-blue-50 text-blue-700 text-xs font-semibold px-2 py-1 rounded">
                   {{ campusShort(req.campus) }}
                </span>
              </td>

              <td class="text-right">
                <div class="flex justify-end gap-2">
                  <button 
                    pButton 
                    type="button" 
                    label="Ablehnen" 
                    class="p-button-outlined p-button-danger p-button-sm"
                    (click)="openDecline(req)"
                  ></button>
                  
                  <button 
                    pButton 
                    type="button" 
                    label="Annehmen" 
                    class="p-button-success p-button-sm"
                    (click)="accept(req)"
                  ></button>
                </div>
              </td>
            </tr>
          </ng-template>

          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="5" class="text-center p-8 text-gray-500">
                Keine offenen Anfragen gefunden.
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    }

    @if (tab === 'done') {
      <div class="bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm">
        <p-table [value]="filteredDone()" [tableStyle]="{ 'min-width': '60rem' }">
          <ng-template pTemplate="header">
            <tr>
              <th class="w-[25%]">Student</th>
              <th class="w-[25%]">Gerät</th>
              <th class="w-[20%]">Zeitraum</th>
              <th class="w-[15%]">Status</th>
              <th class="w-[15%] text-right">Info</th>
            </tr>
          </ng-template>
          
          <ng-template pTemplate="body" let-req>
            <tr class="opacity-75 hover:opacity-100 transition-opacity">
              <td>
                <span class="font-medium">{{ req.studentName }}</span>
              </td>
              <td>
                <span class="font-medium">{{ req.productName }}</span>
                <span class="text-xs text-gray-400 block">{{ req.inventoryNumber }}</span>
              </td>
              <td>
                <span class="text-sm text-gray-600">
                  {{ formatDate(req.fromDate) }} - {{ formatDate(req.toDate) }}
                </span>
              </td>
              <td>
                <span [class]="statusTag(req).cls">
                  {{ statusTag(req).value }}
                </span>
              </td>
              <td class="text-right">
                 @if (req.declineReason) {
                   <i class="pi pi-info-circle text-gray-400" [pTooltip]="req.declineReason"></i>
                 }
              </td>
            </tr>
          </ng-template>

          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="5" class="text-center p-8 text-gray-500">
                Keine vergangenen Anfragen.
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    }
  </div>

  <p-dialog 
    header="Anfrage ablehnen" 
    [(visible)]="isDeclineDialogOpen" 
    [modal]="true" 
    [style]="{ width: '400px' }"
    [draggable]="false" 
    [resizable]="false"
  >
    @if (selectedRequest) {
      <div class="flex flex-col gap-4">
        <p class="text-sm text-gray-600">
          Möchten Sie die Anfrage von <strong>{{ selectedRequest.studentName }}</strong> für 
          <strong>{{ selectedRequest.productName }}</strong> wirklich ablehnen?
        </p>

        <div class="flex flex-col gap-2">
            <label for="reason" class="text-sm font-medium text-gray-700">Grund (optional)</label>
            <textarea 
                id="reason"
                rows="3" 
                class="w-full p-2 border border-gray-300 rounded text-sm"
                [(ngModel)]="declineReason"
                placeholder="z.B. Gerät ist in Wartung..."
            ></textarea>
        </div>

        @if (declineError) {
            <small class="text-red-600">{{ declineError }}</small>
        }
      </div>

      <ng-template pTemplate="footer">
        <button 
            pButton 
            type="button" 
            label="Abbrechen" 
            class="p-button-text" 
            (click)="closeDecline()"
        ></button>
        <button 
            pButton 
            type="button" 
            label="Ablehnen bestätigen" 
            class="p-button-danger" 
            (click)="confirmDecline()"
        ></button>
      </ng-template>
    }
  </p-dialog>
</div>