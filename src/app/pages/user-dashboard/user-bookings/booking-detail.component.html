<div class="p-8 max-w-6xl mx-auto">
  <p-toast position="bottom-right"></p-toast>
  <p-confirmDialog></p-confirmDialog>

  <div class="flex items-center justify-between mb-4">
    <app-back-button (backClick)="goBack()"></app-back-button>

    <div class="flex gap-2">
      <app-filled-button
        icon="pi pi-file-pdf"
        label="Export PDF"
        (buttonClick)="exportToPdf()">
      </app-filled-button>

      <app-filled-button
        icon="pi pi-qrcode"
        label="QR-Codes anzeigen"
        (buttonClick)="openQrDialog()">
      </app-filled-button>
    </div>
  </div>

  @if (pageService.isLoading()) {
    <div class="text-center py-8 flex flex-col items-center justify-center">
      <i class="pi pi-spin pi-spinner text-4xl text-[#253359]"></i>
      <p class="mt-4 text-gray-600">Lade Buchungsdetails...</p>
    </div>
  }

  @if (!pageService.isLoading() && pageService.booking()) {
    <div class="mt-4 space-y-6">

      <!-- Header -->
      <app-booking-header
        [bookingId]="pageService.booking()!.id"
        [productName]="pageService.booking()!.productName"
        [itemInvNumber]="pageService.booking()!.itemInvNumber"
        [status]="pageService.booking()!.status"
        [statusLabel]="pageService.getStatusLabel(pageService.booking()!.status)"
        [statusSeverity]="pageService.getStatusSeverity(pageService.booking()!.status)">
      </app-booking-header>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">

        <div class="space-y-6 mt-4">

          <app-info-card
            header="Ausleihzeitraum"
            [items]="pageService.rentalPeriodItems()">
          </app-info-card>

          <app-info-card
            header="Verleiher"
            [items]="pageService.lenderItems()">
          </app-info-card>

          <app-info-card
            header="Gegenstand"
            [items]="pageService.itemItems()">
          </app-info-card>

          <!-- Termine & Daten -->
          <app-info-card
            header="Termine & Daten"
            [items]="pageService.datesItems()">
          </app-info-card>

          <!-- Abholtermin auswählen Button (nur bei PENDING/CONFIRMED) -->
          @if (pageService.booking()!.status === 'PENDING' || pageService.booking()!.status === 'CONFIRMED') {
            @if (pageService.booking()!.proposedPickups && !pageService.booking()!.confirmedPickup) {
              <div>
                <app-filled-button
                  label="Abholtermin auswählen"
                  icon="pi pi-calendar-plus"
                  (buttonClick)="openPickupDialog()"
                  class="w-full">
                </app-filled-button>
              </div>
            }
          }

          <!-- Buchung stornieren Button (nur bei PENDING/CONFIRMED) -->
          @if (pageService.canCancelBooking()) {
            <div>
              <app-secondary-button
                label="Buchung stornieren"
                icon="pi pi-times"
                color="red"
                (buttonClick)="cancelBooking()"
                class="w-full">
              </app-secondary-button>
            </div>
          }

        </div>

        <div class="space-y-6 mt-4">
          <app-booking-progress
            [timelineEvents]="pageService.timelineEvents()"
            [formatDateTime]="pageService.formatDate.bind(pageService)">
          </app-booking-progress>

          <app-booking-message [message]="pageService.booking()!.message"></app-booking-message>
        </div>


      </div>

    </div>
  }

  @if (!pageService.isLoading() && pageService.booking()) {
    <app-booking-qr
      [visible]="pageService.showQrDialog()"
      [bookingId]="pageService.booking()!.id"
      (closed)="onQrClosed()">
    </app-booking-qr>

    <app-pickup-selection-dialog
      [visible]="pageService.showPickupDialog()"
      (visibleChange)="onPickupDialogVisibleChange($event)"
      [proposedPickups]="pageService.parseProposedPickups(pageService.booking()!.proposedPickups || '')"
      [canSelectProposed]="pageService.canSelectProposedPickups()"
      [formatDateTime]="pageService.formatDate.bind(pageService)"
      (pickupSelected)="onPickupSelected($event)"
      (newPickupsProposed)="onNewPickupsProposed($event)"
      (cancelled)="onPickupDialogCancelled()">
    </app-pickup-selection-dialog>
  }

  @if (!pageService.isLoading() && !pageService.booking()) {
    <div class="text-center flex flex-col items-center justify-center py-8">
      <i class="pi pi-exclamation-triangle text-red-500 text-5xl mb-4"></i>
      <h2 class="text-xl font-bold text-gray-800 mb-2">Buchung nicht gefunden</h2>
      <p class="text-gray-600 mb-4">Die angeforderte Buchung konnte nicht geladen werden.</p>
      <app-back-button (backClick)="goBack()"></app-back-button>
    </div>
  }


</div>
